#!/usr/bin/zsh

POLICY_UNLOCKED=apply-policy
POLICY_LOCKED=reject

radio_state() {
 wifi $1
 wwan $1
 bluetooth $1
}

stop_vpn() {
  nmcli con show --active | grep vpn | cut -d' ' -f1 | xargs -n1 nmcli con down
}

stop_wwan() {
  nmcli con show --active | grep gsm | cut -d' ' -f1 | xargs -n1 nmcli con down
}

stop_wlan() {
  nmcli con show --active | grep wifi | cut -d' ' -f1 | xargs -n1 nmcli con down
}

before_lock() {
  usbguard set-parameter InsertedDevicePolicy $POLICY_LOCKED
  killall compton
  pauseallmpv 2>/dev/null
  playerctl pause 2>/dev/null
  fusermount -u ~/Vault &
  fusermount -u ~/Vault-Share &
  physlock -lms
  sudo systemctl stop pcscd.service
}

after_lock() {
  physlock -L
  py3-cmd refresh backlight keyboard_layout
  usbguard_unlock
  compton & disown
}


usbguard_unlock(){
  usbguard set-parameter InsertedDevicePolicy $POLICY_UNLOCKED
}

trap usbguard_unlock SIGHUP SIGINT SIGTERM

case "$1" in
  lock)
    before_lock
    xsecurelock
    after_lock
    ;;
  logout)
    stop_vpn
    i3-msg exit
    ;;
  greeter)
    dm-tool switch-to-greeter
    ;;
  suspend)
    before_lock
    stop_vpn
    stop_wwan
    systemctl -i suspend
    xsecurelock
    after_lock
    nmcli device wifi rescan
    ;;
  reboot)
    stop_vpn
    stop_wwan
    systemctl -i reboot
    ;;
  shutdown)
    stop_vpn
    stop_wwan
    systemctl -i poweroff
    ;;
  *)
    echo "Usage: $0 {lock|logout|suspend|reboot|shutdown}"
    exit 2
esac

exit 0

#!/usr/bin/zsh

POLICY_UNLOCKED=apply-policy
POLICY_LOCKED=reject

radio_state() {
 wifi $1
 wwan $1
 bluetooth $1
}

before_lock() {
  # setxkbmap -layout fr azerty; sleep 0.2; setxkbmap fr,us,fr,ru azerty,,bepo, -option "grp:shifts_toggle,compose:caps"
  pauseallmpv
  py3-cmd refresh keyboard_layout
  usbguard set-parameter InsertedDevicePolicy $POLICY_LOCKED
  killall compton
  sudo systemctl stop pcscd.service
  playerctl pause 2>/dev/null
  light -O
  sleep 0.1
  light -S 10
  fusermount -u ~/Vault &
  fusermount -u ~/Vault-Share &
  py3-cmd refresh backlight
}

after_lock() {
  light -I
  py3-cmd refresh backlight keyboard_layout
  usbguard_unlock
  compton --no-fading-openclose & disown
}

stop_vpn() {
  nmcli con show --active | grep vpn | cut -d' ' -f1 | xargs -n1 nmcli con down
}

stop_wwan() {
  nmcli con show --active | grep gsm | cut -d' ' -f1 | xargs -n1 nmcli con down
}

stop_wlan() {
  nmcli con show --active | grep wifi | cut -d' ' -f1 | xargs -n1 nmcli con down
}

usbguard_unlock(){
  usbguard set-parameter InsertedDevicePolicy $POLICY_UNLOCKED
}

trap usbguard_unlock SIGHUP SIGINT SIGTERM

case "$1" in
  lock)
    before_lock
    physlock -lms
    xsecurelock
    physlock -L
    after_lock
    ;;
  logout)
    stop_vpn
    i3-msg exit
    ;;
  greeter)
    dm-tool switch-to-greeter
    ;;
  suspend)
    notify-send "Suspending" "in progess.."
    physlock -lms
    before_lock
    stop_vpn
    stop_wlan
    stop_wwan
    radio_state off
    sleep 2
    systemctl -i suspend
    radio_state on
    xsecurelock
    physlock -L
    after_lock
    ;;
  reboot)
    stop_vpn
    stop_wwan
    stop_wlan
    systemctl -i reboot
    ;;
  shutdown)
    stop_vpn
    stop_wwan
    stop_wlan
    systemctl -i poweroff
    ;;
  *)
    echo "Usage: $0 {lock|logout|suspend|reboot|shutdown}"
    exit 2
esac

exit 0

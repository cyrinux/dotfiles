#!/bin/bash

trap 'pkill -P $$' EXIT

get_progress() {
    class="$1"
    output=$(progress -q -c "$class")
    [ -n "$output" ] && percentage="$(echo -e "$output" | awk 'BEGIN {i=0} NR%3==2 {sum +=$1; i+=1} END {print sum/i}')"
    text="${percentage}%"
    tooltip="$(echo $output | perl -pe 's/\n/\\n/g' | perl -pe 's/(?:\\n)+$//'))"
    if [ -n "$percentage" ] && [ "${percentage%.*}" -gt 0 ]; then
        case $class in
            "cp") text=" $text" ;;
            "gpg") text=" $text" ;;
            "mv") text=" $text" ;;
            "rsync") text=" $text" ;;
            "tar") text=" $text" ;;
            *) text="" ;;
        esac
        json=$(printf '{"text": "%s", "tooltip": "%s", "class": "%s", "percentage": "%.0f"}\n' "$text" "$tooltip" "$class" "$percentage")
        echo -n $json
    fi
}

get_progress "$1"

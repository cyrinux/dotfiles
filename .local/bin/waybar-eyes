#!/bin/bash
set -euo pipefail
marker="${XDG_CACHE_HOME}/waybar-eyes"
lock="${XDG_CACHE_HOME}/waybar-eyes.lock"
eyes=""

run() {
    exec 100> ${lock} || exit 1
    flock 100 || exit 1
    while true; do
        printf '{"text": "%s"}\n' "$(echo "$eyes" | xargs)"
        touch "$marker"
        inotifywait -t 900 -q "$marker"
        [ -f "$marker" ] && eyes="$eyes ÔÅÆ" || eyes=""
    done
}

[ "$1" = "done" ] && rm "$marker" || run

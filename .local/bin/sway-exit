#!/bin/sh

set -u

stop_vpn() {
    nmcli con show --active | grep vpn | cut -d' ' -f1 | xargs -n1 nmcli con down
}

stop_wwan() {
    nmcli con show --active | grep gsm | cut -d' ' -f1 | xargs -n1 nmcli con down
}

stop_wlan() {
    nmcli con show --active | grep wifi | cut -d' ' -f1 | xargs -n1 nmcli con down
}

before_lock() {
    playerctl -a pause > /dev/null 2>&1
    sway-cast stop
    fusermount -u ~/Vault > /dev/null 2>&1
    # gpg-connect-agent --no-autostart reloadagent /bye > /dev/null 2>&1
}

case "$1" in
    exit)
        systemctl --user stop sway-session.target
        swaymsg exit
        ;;
    lock)
        before_lock
        loginctl lock-session
        waybar-eyes done
        ;;
    suspend)
        before_lock
        stop_vpn
        stop_wwan
        pkill -9 -f kanshi
        kanshi &
        sleep 2
        systemctl suspend
        pkill -9 -f kanshi
        kanshi &
        systemctl --user restart wlsunset
        waybar-eyes done
        gpgconf --kill scdaemon
        ;;
    reboot)
        stop_vpn
        stop_wwan
        systemctl -i reboot
        ;;
    shutdown)
        stop_vpn
        stop_wwan
        systemctl -i poweroff
        ;;
    *)
        echo "Usage: $0 {exit|lock|suspend|reboot|shutdown}"
        exit 2
        ;;
esac

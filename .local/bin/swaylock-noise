#!/bin/bash
# Lightly modified glichting screen lock script by xzvf

exec 4<> $XDG_RUNTIME_DIR/swaylock-noise.lock || exit 1
flock -n 4 || {
    echo "ERROR: flock() failed." >&2
    exit 1
}
pngfile="/tmp/sclock.png"
bmpfile="/tmp/sclock.bmp"
glitchedfile="/tmp/sclock_g.bmp"

grim $pngfile

# convert to bmp and pixelate
magick convert -rotate -90 $pngfile $bmpfile

for a in {1,2,4,5,10}; do
    # Glitch it with sox FROM: https://maryknize.com/blog/glitch_art_with_sox_imagemagick_and_vim/
    sox -t ul -c 1 -r 48k $bmpfile -t ul $glitchedfile trim 0 90s : echo 1 1 $((a * 2)) 0.1 2> /dev/null
    # Rotate it by 90 degrees
    magick convert -scale 25% -scale 400% -rotate 90 $glitchedfile $bmpfile 2> /dev/null
    #Glitch it again and rotate it back
    sox -t ul -c 1 -r 48k $bmpfile -t ul $glitchedfile trim 0 100s : flanger 2> /dev/null
done

# Add lock icon, pixelate and convert back to png
magick convert $bmpfile $pngfile > /dev/null

swaylock -i $pngfile
rm $pngfile $bmpfile $glitchedfile

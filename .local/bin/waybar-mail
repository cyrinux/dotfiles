#!/bin/bash

lock="${XDG_CACHE_HOME}/waybar-mail.lock"

check() {
    exec 100> ${lock} || exit 1
    flock 100 || exit 1
    count="$(notmuch count 'tag:unread')"
    tooltip="There are $count new emails"
    if [ "$count" = "0" ]; then
        printf '{"text": ""}\n'
    else
        printf "{\"text\": \"<span foreground='#928374'>ïƒ </span> %s\", \"tooltip\": \"%s\"}\n" "$count" "$tooltip"
    fi
    inotifywait -q -e move -e create -e delete ~/.mail/personal/INBOX/cur > /dev/null
    check
}

check

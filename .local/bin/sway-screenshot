#!/usr/bin/env bash
set -ueo pipefail

mkdir -p /tmp/screenshots
cd /tmp/screenshots || exit 1

systemctl --user stop sway-inactive-window-transparency.service

case ${1:-monitor} in
	window)
		window="$(swaymsg -t get_tree | jq '.. | select(type == "object") | select(.focused)')"
		x="$(jq .rect.x <<< "$window")"
		y="$(jq .rect.y <<< "$window")"
		width="$(jq .rect.width <<< "$window")"
		height="$(jq .rect.height <<< "$window")"
		output="${x},${y} ${width}x${height}"
		grim -g "$output" -t png screen.png
		;;
	monitor | selection)
		output=$(swaymsg -t get_outputs | jq -r '.[] | select(.focused)' | jq -r '.name')
		grim -o "$output" -t png screen.png
		;;
	*)
		printf "Usage: %s [ monitor | window | selection ]" "$0"
		exit 0
		;;
esac

vimiv -f -s statusbar.show false screen.png &

geometry="$(slurp -b '#AFAFAFAF' -c '#FF3F3FAF' -s '#00000000' -w 3 -d -o)"
if [ -n "$geometry" ]; then
	grim -g "$geometry" -t png area.png
else
	grim -t png area.png
fi

kill $!

[ -f area.png ] && swappy -f area.png
wl-copy < area.png

systemctl --user start sway-inactive-window-transparency.service

rm -f screen.png area.png

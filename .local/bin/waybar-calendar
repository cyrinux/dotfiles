#!/bin/bash

exit 1

set -eu
trap 'pkill -P $$' EXIT

tooltip="$(timeout 5 khal at | grep -v 'No events' | perl -pe 's/\n/\\n/g' | perl -pe 's/(?:\\n)+$//')"
day="$(date +'%d/%m/%Y')"
counter=$(echo $tooltip | grep -c ", $day")
class=off
text=""

if [ "$counter" -gt 0 ]; then
	icon='ÔÅ≥'
	class=on
	text="$icon $counter"
fi
printf '{"text": "%s", "tooltip": "%s", "class": "%s"}\n' "$text" "$tooltip" "$class"
